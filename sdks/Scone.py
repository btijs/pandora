import logging

from sdks.AbstractSGXSDK import AbstractSGXSDK
from sdks.common import write_struct_to_memory, write_bvv_to_memory, Tcs

logger = logging.getLogger(__name__)

EXPECTED_SYMBOL = '__scone_entry'
oentry_adrs = None

PAGE_SIZE = 0x1000

MAP_HEAD_FS_OFFSET = 0xa5000 # offset from fs_base to *enclave_map_head
# TODO we can also simply compute these offset using pyelftools
TCS_OFFSET = 0x4974000       # offset from enclave base to tcs

def zero_init_page(init_state, rel_addr):
    write_bvv_to_memory(init_state, rel_addr, b'\00' * PAGE_SIZE, bits=8*PAGE_SIZE)

class Scone(AbstractSGXSDK):
    def __init__(self, elffile, init_state, version_str, **kwargs):
        super().__init__(elffile, init_state, version_str, **kwargs)
        logger.debug(f'Initializing basic TCS.')

        tcs_struct = self.build_tcs()
        write_struct_to_memory(init_state, self.get_tcs(), tcs_struct)

        zero_init_page(init_state, tcs_struct.ogs_base)
        zero_init_page(init_state, tcs_struct.ofs_base)

        # now put some magic bytes in the FS page (from scone-gdb)
        write_bvv_to_memory(init_state, tcs_struct.ofs_base, MAP_HEAD_FS_OFFSET, bits=64)
        write_bvv_to_memory(init_state, tcs_struct.ofs_base+8, TCS_OFFSET, bits=64)

        # write the enclave symbol table
        map_page_addr = tcs_struct.ofs_base + MAP_HEAD_FS_OFFSET
        for i in range(0, len(ENCLAVE_INIT_MAP_PAGE)):
            qword=ENCLAVE_INIT_MAP_PAGE[i]
            write_bvv_to_memory(init_state, map_page_addr+8*i, qword, bits=64)

    @staticmethod
    def detect(elffile, binpath):
        symtab = elffile.get_section_by_name('.symtab')
        if not symtab:
            return ''

        syms = symtab.get_symbol_by_name(EXPECTED_SYMBOL)
        if not syms or len(syms) > 1:
            return ''

        global oentry_adrs
        oentry_adrs = syms[0]['st_value']
        logger.debug(f'Found {EXPECTED_SYMBOL} at {oentry_adrs:#x}')

        return AbstractSDK.match_strings(binpath, 'SCONE version: ')

    @staticmethod
    def get_sdk_name():
        return 'Scone'

    def get_tcs(self):
        """
        NOTE: this was extracted via scone-gdb:
            - breakpoint on eenter()
            - read out tcs
        """
        return 0x1004974000

    def build_tcs(self):
        tcs_struct = Tcs()

        tcs_struct.ofs_base = 0x4972000
        tcs_struct.ogs_base = 0x4973000

        assert oentry_adrs != None
        tcs_struct.oentry = oentry_adrs

        return tcs_struct

    def get_encl_size(self):
        """
        NOTE: this was extracted via scone-gdb:
            - breakpoint on ecreate()
            - read out secs
        """
        return 0x8000000

    @staticmethod
    def get_load_addr():
        return 0x1000000000

    def get_base_addr(self):
        return Scone.get_load_addr()
    
    def modify_init_state(self, init_state):
        # Scone can be sped up if RDX is set to 3 at initialization (the thread that performs the work)
        # hack to limit paths
        init_state.regs.rdi = 3
        logger.info('SCONE: Initializing rdi with 3 to limit paths.')


# extracted with scone-gdb script
ENCLAVE_INIT_MAP_PAGE = [
    0x0000000000000030, 0x0000000000000001,
    0x0000000000010000, 0x0000000000001000,
    0x0000000000000005, 0x0000000000000000,
    0x0000000000000060, 0x0000000000000001,
    0x0000000000210000, 0x0000000000002000,
    0x0000000000000003, 0x0000000000000000,
    0x00000000000000a7, 0x0000000000000002,
    0x0000000000212000, 0x0000000000500000,
    0x0000000000000005, 0x0000000000000090,
    0x6f63732e6362696c, 0x365f3638782d656e,
    0xee00312e6f732e34, 0x0200000000000000,
    0x0000000000000000, 0x0000000000009120,
    0x03000000000004c0, 0xd700000000000000,
    0x6c00000000000000, 0x6e6f63732e636269,
    0x34365f3638782d65, 0x011e00312e6f732e,
    0x0003000000000000, 0xe000000000000000,
    0x0000000000000095, 0x0003000000000400,
    0x0000000000000000, 0x014e000000000000,
    0x000a000000000000, 0xe000000000000000,
    0x1000000000000495, 0x0003000000000000,
    0x0000000000000000, 0x017e000000000000,
    0x0004000000000000, 0xf000000000000000,
    0x0000000000000495, 0x0003000000000001,
    0x0000000000000000, 0x01ae000000000000,
    0x0005000000000000, 0xf000000000000000,
    0x1000000000000496, 0x0003000000000000,
    0x0000000000000000, 0x01de000000000000,
    0x0008000000000000, 0x0000000000000000,
    0x2000000000000497, 0x0003000000000000,
    0x0000000000000000, 0x020e000000000000,
    0x0009000000000000, 0x2000000000000000,
    0x2000000000000497, 0x0003000000000000,
    0x0000000000000000, 0x023e000000000000,
    0x0007000000000000, 0x4000000000000000,
    0x1000000000000497, 0x0000000000000000,
    0x0000000000000000, 0x026e000000000000,
    0x0004000000000000, 0x5000000000000000,
    0x0000000000000497, 0x0003000000000001,
    0x0000000000000000, 0x029e000000000000,
    0x0005000000000000, 0x5000000000000000,
    0x1000000000000498, 0x0003000000000000,
    0x0000000000000000, 0x02ce000000000000,
    0x0008000000000000, 0x6000000000000000,
    0x2000000000000498, 0x0003000000000000,
    0x0000000000000000, 0x02fe000000000000,
    0x0009000000000000, 0x8000000000000000,
    0x2000000000000498, 0x0003000000000000,
    0x0000000000000000, 0x032e000000000000,
    0x0007000000000000, 0xa000000000000000,
    0x1000000000000498, 0x0000000000000000,
    0x0000000000000000, 0x035e000000000000,
    0x0004000000000000, 0xb000000000000000,
    0x0000000000000498, 0x0003000000000001,
    0x0000000000000000, 0x038e000000000000,
    0x0005000000000000, 0xb000000000000000,
    0x1000000000000499, 0x0003000000000000,
    0x0000000000000000, 0x03be000000000000,
    0x0008000000000000, 0xc000000000000000,
    0x2000000000000499, 0x0003000000000000,
    0x0000000000000000, 0x03ee000000000000,
    0x0009000000000000, 0xe000000000000000,
    0x2000000000000499, 0x0003000000000000,
    0x0000000000000000, 0x041e000000000000,
    0x0007000000000000, 0x0000000000000000,
    0x100000000000049a, 0x0000000000000000,
    0x0000000000000000, 0x044e000000000000,
    0x0004000000000000, 0x1000000000000000,
    0x000000000000049a, 0x0003000000000001,
    0x0000000000000000, 0x047e000000000000,
    0x0005000000000000, 0x1000000000000000,
    0x100000000000049b, 0x0003000000000000,
    0x0000000000000000, 0x04ae000000000000,
    0x0008000000000000, 0x2000000000000000,
    0x200000000000049b, 0x0003000000000000,
    0x0000000000000000, 0x04de000000000000,
    0x0009000000000000, 0x4000000000000000,
    0x200000000000049b, 0x0003000000000000,
    0x0000000000000000, 0x050e000000000000,
    0x0007000000000000, 0x6000000000000000,
    0x100000000000049b, 0x0000000000000000,
    0x0000000000000000, 0x053e000000000000,
    0x0004000000000000, 0x7000000000000000,
    0x000000000000049b, 0x0003000000000001,
    0x0000000000000000, 0x056e000000000000,
    0x0005000000000000, 0x7000000000000000,
    0x100000000000049c, 0x0003000000000000,
    0x0000000000000000, 0x059e000000000000,
    0x0008000000000000, 0x8000000000000000,
    0x200000000000049c, 0x0003000000000000,
    0x0000000000000000, 0x05ce000000000000,
    0x0009000000000000, 0xa000000000000000,
    0x200000000000049c, 0x0003000000000000,
    0x0000000000000000, 0x05fe000000000000,
    0x0007000000000000, 0xc000000000000000,
    0x100000000000049c, 0x0000000000000000,
    0x0000000000000000, 0x062e000000000000,
    0x0004000000000000, 0xd000000000000000,
    0x000000000000049c, 0x0003000000000001,
    0x0000000000000000, 0x065e000000000000,
    0x0005000000000000, 0xd000000000000000,
    0x100000000000049d, 0x0003000000000000,
    0x0000000000000000, 0x068e000000000000,
    0x0008000000000000, 0xe000000000000000,
    0x200000000000049d, 0x0003000000000000,
    0x0000000000000000, 0x06be000000000000,
    0x0009000000000000, 0x0000000000000000,
    0x200000000000049e, 0x0003000000000000,
    0x0000000000000000, 0x06ee000000000000,
    0x0007000000000000, 0x2000000000000000,
    0x100000000000049e, 0x0000000000000000,
    0x0000000000000000, 0x071e000000000000,
    0x0004000000000000, 0x3000000000000000,
    0x000000000000049e, 0x0003000000000001,
    0x0000000000000000, 0x074e000000000000,
    0x0005000000000000, 0x3000000000000000,
    0x100000000000049f, 0x0003000000000000,
    0x0000000000000000, 0x077e000000000000,
    0x0008000000000000, 0x4000000000000000,
    0x200000000000049f, 0x0003000000000000,
    0x0000000000000000, 0x07ae000000000000,
    0x0009000000000000, 0x6000000000000000,
    0x200000000000049f, 0x0003000000000000,
    0x0000000000000000, 0x07de000000000000,
    0x0007000000000000, 0x8000000000000000,
    0x100000000000049f, 0x0000000000000000,
    0x0000000000000000, 0x080e000000000000,
    0x0004000000000000, 0x9000000000000000,
    0x000000000000049f, 0x0003000000000001,
    0x0000000000000000, 0x083e000000000000,
    0x0005000000000000, 0x9000000000000000,
    0x10000000000004a0, 0x0003000000000000,
    0x0000000000000000, 0x086e000000000000,
    0x0008000000000000, 0xa000000000000000,
    0x20000000000004a0, 0x0003000000000000,
    0x0000000000000000, 0x089e000000000000,
    0x0009000000000000, 0xc000000000000000,
    0x20000000000004a0, 0x0003000000000000,
    0x0000000000000000, 0x08ce000000000000,
    0x0007000000000000, 0xe000000000000000,
    0x10000000000004a0, 0x0000000000000000,
    0x0000000000000000, 0x08fe000000000000,
    0x0006000000000000, 0xf000000000000000,
    0x80000000000004a0, 0x0003000000000000,
    0x0000000000000000, 0x0000000000000000,
    0x000b000000000000, 0x7000000000000000,
    0x10000000000004a1, 0x0003000000000000,
    0x0000000000000000, 0x0002000000000000,
    0x0020000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0xe000000000000000,
    0x0008000000000095, 0x0000000000000000,
    0x0000000000000400, 0x0000000000000001,
    0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0004000000000000,
    0x0000000000000000, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000020,
    0x0000000000000140, 0x0000000000000000,
    0x0000000000000000, 0x0000000000000000,
]
